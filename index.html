<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JB Daily Pro</title>
    <style>
        :root {
            --bg: #000000; --surface: #121212; --surface-alt: #1c1c1e;
            --primary: #30D158; --accent: #0A84FF; --text: #FFFFFF; --text-muted: #8E8E93;
            --danger: #FF453A; --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased; overflow: hidden; }
        .hidden { display: none !important; }
        .btn-reset { background: none; border: none; color: inherit; font: inherit; cursor: pointer; }
        .screen { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; padding-bottom: calc(40px + var(--safe-bottom)); }
        h1 { font-size: 32px; font-weight: 800; letter-spacing: -1px; margin: 0 0 24px 0; }
        .grid-select { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .day-btn { background: var(--surface-alt); padding: 30px 16px; border-radius: 16px; font-size: 18px; font-weight: 700; text-align: center; border: 1px solid #333; }
        .day-btn:active { background: var(--accent); transform: scale(0.96); }
        .card { background: var(--surface); border-radius: 16px; padding: 8px 16px; border: 1px solid #2c2c2e; }
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #2c2c2e; }
        .check-pill { width: 26px; height: 26px; border-radius: 8px; border: 2px solid #3a3a3c; display: flex; align-items: center; justify-content: center; }
        .selected .check-pill { background: var(--accent); border-color: var(--accent); color: white; }
        .session-block { background: var(--surface); border-radius: 14px; margin-bottom: 12px; border: 1px solid #2c2c2e; }
        .is-linked { border-bottom: 3px dashed var(--accent); margin-bottom: 4px; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .session-item { padding: 18px; display: flex; align-items: center; gap: 16px; }
        .status-circle { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #3a3a3c; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; }
        .done { opacity: 0.35; filter: grayscale(1); }
        .done .status-circle { background: var(--primary); border-color: var(--primary); color: black; }
        .fab { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 18px 40px; border-radius: 40px; font-weight: 800; z-index: 100; min-width: 200px; text-align: center; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 24px; backdrop-filter: blur(10px); }
        .modal-content { background: var(--surface-alt); width: 100%; max-width: 440px; border-radius: 28px; padding: 32px; }
        .input-minimal { background: transparent; border: none; border-bottom: 2px solid #3a3a3c; color: white; font-size: 48px; font-weight: 800; width: 100%; text-align: center; outline: none; margin: 20px 0; }
    </style>
</head>
<body>
    <div id="loader" class="overlay hidden"><div style="font-weight:700; color:var(--accent);">SYNCING...</div></div>
    <div id="screen-home" class="screen">
        <h1 id="dateDisplay">JB DAILY</h1>
        <div class="grid-select">
            <button class="day-btn" onclick="openMenu('Push')">Push</button>
            <button class="day-btn" onclick="openMenu('Pull')">Pull</button>
            <button class="day-btn" onclick="openMenu('Legs')">Legs</button>
            <button class="day-btn" onclick="openMenu('Core')">Core</button>
        </div>
    </div>
    <div id="screen-menu" class="screen hidden">
        <div style="display:flex; align-items:center; margin-bottom:24px;">
            <button class="btn-reset" onclick="goHome()" style="font-size:28px; padding-right:20px;">‚Üê</button>
            <h2 id="menuTitle">ROUTINE</h2>
        </div>
        <div id="menuList" class="card"></div>
        <button class="fab btn-reset" onclick="startWeightEntry()">START WORKOUT <span id="selCount">0</span></button>
    </div>
    <div id="modal-weight" class="overlay hidden">
        <div class="modal-content">
            <h2 style="text-align:center;">Weight (LBS)</h2>
            <input type="number" id="weightInput" class="input-minimal" placeholder="000.0" step="0.1">
            <button class="btn-reset" onclick="confirmWeightAndStart()" style="width:100%; background:var(--accent); color:white; padding:20px; border-radius:16px; font-weight:800;">Continue</button>
        </div>
    </div>
    <div id="screen-session" class="screen hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="color:var(--accent);">TRAINING</h2>
            <button class="btn-reset" onclick="openFinishModal()" style="color:var(--primary); font-weight:800;">FINISH</button>
        </div>
        <div id="sessionList"></div>
    </div>
    <div id="modal-finish" class="overlay hidden">
        <div class="modal-content">
            <h2 style="color:var(--primary); text-align:center;">COMPLETE</h2>
            <p id="summaryStats" style="text-align:center; color:var(--text-muted);"></p>
            <button class="btn-reset" onclick="confirmFinish()" style="width:100%; background:var(--primary); color:black; padding:20px; border-radius:16px; font-weight:900; margin-top:20px;">SAVE TO CLOUD</button>
            <button class="btn-reset" onclick="clearWorkout()" style="width:100%; color:var(--danger); margin-top:20px; font-size:12px;">Reset Workout</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwzpPVFs3eB0RGfEpl_DDZ7HK6sfnmm7vSEKN2ZwL-23a4_U110GR5QdU7pGRFdg2161w/exec';
        let db = { exercises: [] };
        let activeSession = null;
        let selectedIds = new Set();
        const todayKey = new Date().toISOString().split('T')[0];

        async function syncData() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const res = await fetch(API_URL);
                db = await res.json();
                document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }).toUpperCase();
                loadPersistedSession(); // Check for existing workout
            } catch(e) { console.error(e); }
            document.getElementById('loader').classList.add('hidden');
        }

        function saveState() { localStorage.setItem('jb_active_session', JSON.stringify(activeSession)); }

        function loadPersistedSession() {
            const saved = localStorage.getItem('jb_active_session');
            if (saved) {
                activeSession = JSON.parse(saved);
                if (activeSession) {
                    renderSession();
                    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                    document.getElementById('screen-session').classList.remove('hidden');
                }
            }
        }

        function goHome() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-home').classList.remove('hidden');
        }

        function openMenu(day) {
            selectedIds.clear();
            document.getElementById('selCount').textContent = '0';
            document.getElementById('menuTitle').textContent = day.toUpperCase();
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-menu').classList.remove('hidden');
            const filtered = db.exercises.filter(e => e.tags.includes(day));
            document.getElementById('menuList').innerHTML = filtered.map(ex => `
                <div class="item-row" id="row-${ex.id}" onclick="toggleSelect(${ex.id})">
                    <div class="item-name">${ex.name}</div>
                    <div class="check-pill"></div>
                </div>
            `).join('');
        }

        function toggleSelect(id) {
            const row = document.getElementById('row-'+id);
            if(selectedIds.has(id)) { selectedIds.delete(id); row.classList.remove('selected'); row.querySelector('.check-pill').innerHTML = ''; }
            else { selectedIds.add(id); row.classList.add('selected'); row.querySelector('.check-pill').innerHTML = '‚úì'; }
            document.getElementById('selCount').textContent = selectedIds.size;
        }

        function startWeightEntry() { if(selectedIds.size > 0) document.getElementById('modal-weight').classList.remove('hidden'); }

        function confirmWeightAndStart() {
            const val = document.getElementById('weightInput').value;
            if(val) fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'log_weight', payload: { date: todayKey, value: val } }) });
            document.getElementById('modal-weight').classList.add('hidden');
            const orderedItems = Array.from(selectedIds).map(id => db.exercises.find(e => e.id === id));
            activeSession = { id: Date.now(), startTime: Date.now(), items: orderedItems.map(e => ({...e, done:false, linked:false})) };
            saveState();
            renderSession();
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-session').classList.remove('hidden');
        }

        function renderSession() {
            document.getElementById('sessionList').innerHTML = activeSession.items.map((item, i) => `
                <div class="session-block ${item.linked ? 'is-linked' : ''} ${item.done ? 'done' : ''}">
                    <div class="session-item">
                        <div class="status-circle" onclick="toggleDone(${i})">${item.done ? '‚úì' : i+1}</div>
                        <div style="flex:1" onclick="toggleDone(${i})">
                            <div class="item-name" style="font-size:17px; font-weight:600;">${item.name}</div>
                        </div>
                        <button class="btn-reset" onclick="toggleLink(${i})" style="color:var(--accent); font-size:24px;">${item.linked ? 'üîì' : 'üîó'}</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleDone(i) { activeSession.items[i].done = !activeSession.items[i].done; saveState(); renderSession(); }
        function toggleLink(i) { activeSession.items[i].linked = !activeSession.items[i].linked; saveState(); renderSession(); }

        function openFinishModal() {
            document.getElementById('summaryStats').textContent = `${activeSession.items.filter(i=>i.done).length} MOVEMENTS COMPLETE`;
            document.getElementById('modal-finish').classList.remove('hidden');
        }

        function confirmFinish() {
            activeSession.endTime = Date.now();
            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'log_workout', payload: activeSession }) });
            clearWorkout();
        }

        function clearWorkout() { localStorage.removeItem('jb_active_session'); activeSession = null; document.getElementById('modal-finish').classList.add('hidden'); goHome(); }

        syncData();
    </script>
</body>
</html>

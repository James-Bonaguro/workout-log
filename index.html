<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JB Daily (Cloud)</title>
    <style>
        :root {
            --bg: #121212; --surface: #1e1e1e; --surface-alt: #2d2d2d;
            --primary: #BB86FC; --text: #e0e0e0; --text-muted: #a0a0a0;
            --success: #03dac6; --danger: #cf6679;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; }
        
        .hidden { display: none !important; }
        .btn-reset { background: none; border: none; color: inherit; font: inherit; cursor: pointer; padding: 0; }
        .screen { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; padding-bottom: calc(20px + var(--safe-bottom)); }
        
        /* Loading Overlay */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* UI Elements */
        .header-date { font-size: 32px; font-weight: 800; margin-bottom: 24px; letter-spacing: -1px; }
        .card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .day-btn { background: var(--surface-alt); padding: 30px 20px; border-radius: 16px; font-size: 20px; font-weight: 600; text-align: center; border: 1px solid #333; display: block; width: 100%; margin-bottom: 12px; }
        .day-btn:active { background: var(--primary); color: black; }
        
        .item-card { background: var(--surface); padding: 16px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border: 2px solid transparent; }
        .item-card.selected { border-color: var(--primary); background: rgba(187,134,252,0.05); }
        .tag { font-size: 10px; background: #333; padding: 3px 8px; border-radius: 4px; color: #ccc; font-weight: 600; text-transform: uppercase; margin-right: 4px; }
        
        /* Modal & Inputs */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: none; align-items: flex-end; }
        .modal.open { display: flex; }
        .modal-pane { background: #1a1a1a; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; }
        .input-text { width: 100%; background: #333; border: none; padding: 14px; border-radius: 12px; color: white; font-size: 16px; margin-bottom: 16px; }
        .fab { position: fixed; bottom: 30px; right: 20px; background: var(--primary); color: #000; padding: 16px 24px; border-radius: 50px; font-weight: 700; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 50; }
        
        /* Session */
        .session-item { background: var(--surface); padding: 16px; border-radius: 12px; display: flex; gap: 16px; margin-bottom: 12px; }
        .check-circle { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--text-muted); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .session-item.done .check-circle { background: var(--success); border-color: var(--success); color: black; }
        .session-item.done h3 { text-decoration: line-through; opacity: 0.5; }
        
        /* Supersets */
        .superset-wrap { position: relative; }
        .link-bar { position: absolute; left: 15px; width: 4px; background: var(--primary); display: none; z-index: 0;}
        .is-linked-start { margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .is-linked-start + .link-bar { display: block; top: 40px; bottom: -20px; }
        .is-linked-mid { margin: 0; border-radius: 0; border-top: 1px solid #333; }
        .is-linked-mid + .link-bar { display: block; top: -20px; bottom: -20px; }
        .is-linked-end { margin-top: 0; border-top-left-radius: 0; border-top-right-radius: 0; border-top: 1px solid #333; }
        .is-linked-end + .link-bar { display: block; top: -20px; bottom: 40px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="color:white; font-weight:600;">Syncing Cloud...</div>
    </div>

    <div id="screen-home" class="screen">
        <div class="header-date" id="dateDisplay"></div>
        
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:600; color:var(--text-muted);">WEIGH IN (LBS)</span>
            <input type="number" id="weightInput" style="background:transparent; border:none; color:var(--primary); font-size:32px; font-weight:700; width:100px; text-align:right;" placeholder="---" onblur="saveWeight()">
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:30px;">
            <button class="day-btn" onclick="openMenu('Push')">Push</button>
            <button class="day-btn" onclick="openMenu('Pull')">Pull</button>
            <button class="day-btn" onclick="openMenu('Legs')">Legs</button>
            <button class="day-btn" onclick="openMenu('Core')">Core</button>
        </div>
        
        <button class="btn-reset" onclick="openManage()" style="text-align:center; color:var(--text-muted); text-decoration:underline; padding:20px;">Manage Database</button>
    </div>

    <div id="screen-menu" class="screen hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <button class="btn-reset" onclick="goHome()" style="font-size:24px;">‚Üê</button>
            <h2 style="margin:0;" id="menuTitle">Push</h2>
            <div style="width:24px;"></div>
        </div>
        <div id="menuList"></div>
        <button class="fab btn-reset" onclick="startSession()">START <span id="selCount" style="background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:10px;">0</span></button>
    </div>

    <div id="screen-session" class="screen hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <button class="btn-reset" onclick="goHome()" style="color:var(--text-muted);">Hide</button>
            <button class="btn-reset" onclick="finishSession()" style="color:var(--success); font-weight:bold;">FINISH</button>
        </div>
        <div id="sessionList"></div>
    </div>

    <div id="screen-manage" class="screen hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <button class="btn-reset" onclick="goHome()" style="font-size:24px;">‚Üê</button>
            <h2 style="margin:0;">Database</h2>
            <button class="btn-reset" onclick="openAddModal()" style="color:var(--primary); font-size:24px;">+</button>
        </div>
        <div id="manageList"></div>
    </div>

    <div id="modal-add" class="modal">
        <div class="modal-pane">
            <h2 style="margin-top:0;">Add Exercise</h2>
            <input type="text" id="addName" class="input-text" placeholder="Exercise Name">
            <input type="text" id="addNotes" class="input-text" placeholder="Notes / Muscle Group">
            <div style="display:flex; gap:8px; margin-bottom:20px;">
                <button class="btn-reset tag" onclick="this.classList.toggle('selected')" data-val="Push" style="padding:12px; flex:1; text-align:center; background:#333;">Push</button>
                <button class="btn-reset tag" onclick="this.classList.toggle('selected')" data-val="Pull" style="padding:12px; flex:1; text-align:center; background:#333;">Pull</button>
                <button class="btn-reset tag" onclick="this.classList.toggle('selected')" data-val="Legs" style="padding:12px; flex:1; text-align:center; background:#333;">Legs</button>
                <button class="btn-reset tag" onclick="this.classList.toggle('selected')" data-val="Core" style="padding:12px; flex:1; text-align:center; background:#333;">Core</button>
            </div>
            <button class="btn-reset" onclick="saveExercise()" style="width:100%; background:var(--primary); padding:16px; border-radius:12px; color:black; font-weight:bold;">Save</button>
            <button class="btn-reset" onclick="document.getElementById('modal-add').classList.remove('open')" style="width:100%; padding:16px; margin-top:10px; color:var(--text-muted);">Cancel</button>
        </div>
    </div>

    <script>
        // ==========================================
        //  ‚ö†Ô∏è PASTE YOUR GOOGLE SHEET URL HERE
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzoEunDp33IT-AGGp9foxIRs8ps7IESMDPxz0B7p2_AWZT4Uu5jJZSG5CxIHg9xGww4Jw/exec'; 

        // STATE
        let db = { exercises: [], history: [], weight: {} };
        let activeSession = null;
        let selectedIds = new Set();
        const todayKey = new Date().toISOString().split('T')[0];

        // --- CLOUD SYNC ---
        async function syncData() {
            if(API_URL.includes('PASTE')) return alert("Please add your API URL in the code!");
            document.getElementById('loader').classList.remove('hidden');
            try {
                const res = await fetch(API_URL);
                db = await res.json();
                renderApp();
            } catch(e) { alert("Sync Failed: " + e); }
            document.getElementById('loader').classList.add('hidden');
        }

        async function postData(action, payload) {
            // Optimistic UI update happens in caller
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // standard for GAS
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload })
            });
        }

        // --- CORE UI ---
        function init() {
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            syncData();
        }

        function renderApp() {
            if(db.weight[todayKey]) document.getElementById('weightInput').value = db.weight[todayKey];
            renderManage();
        }

        function goHome() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-home').classList.remove('hidden');
        }

        // --- ACTIONS ---
        function saveWeight() {
            const val = document.getElementById('weightInput').value;
            if(!val) return;
            db.weight[todayKey] = val;
            postData('log_weight', { date: todayKey, value: val });
        }

        function saveExercise() {
            const name = document.getElementById('addName').value;
            const notes = document.getElementById('addNotes').value;
            const tags = Array.from(document.querySelectorAll('#modal-add .tag.selected')).map(el => el.dataset.val);
            
            if(!name || tags.length === 0) return alert("Name and at least 1 Day required");

            const newEx = { id: Date.now(), name, notes, tags };
            db.exercises.push(newEx);
            
            postData('save_exercise', db.exercises); // Send full list
            document.getElementById('modal-add').classList.remove('open');
            renderManage();
        }

        function deleteExercise(id) {
            if(!confirm("Delete?")) return;
            db.exercises = db.exercises.filter(e => e.id !== id);
            postData('save_exercise', db.exercises);
            renderManage();
        }

        function finishSession() {
            if(!confirm("Finish Workout?")) return;
            activeSession.endTime = Date.now();
            
            // Log to local state & Cloud
            db.history.push(activeSession);
            postData('log_workout', activeSession);
            
            activeSession = null;
            goHome();
        }

        // --- BUILDER / SESSION ---
        function openMenu(day) {
            selectedIds.clear();
            document.getElementById('selCount').textContent = '0';
            document.getElementById('menuTitle').textContent = day;
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-menu').classList.remove('hidden');
            
            const list = document.getElementById('menuList');
            const filtered = db.exercises.filter(e => e.tags.includes(day));
            
            list.innerHTML = filtered.map(ex => `
                <div class="item-card" id="card-${ex.id}" onclick="toggleSelect(${ex.id})">
                    <div>
                        <h3 style="margin:0;">${ex.name}</h3>
                        <div style="font-size:12px; color:#888; margin-top:4px;">${ex.notes || ''}</div>
                    </div>
                    <span id="check-${ex.id}" style="font-size:20px;">‚¨ú</span>
                </div>
            `).join('');
        }

        function toggleSelect(id) {
            if(selectedIds.has(id)) {
                selectedIds.delete(id);
                document.getElementById('card-'+id).classList.remove('selected');
                document.getElementById('check-'+id).textContent = '‚¨ú';
            } else {
                selectedIds.add(id);
                document.getElementById('card-'+id).classList.add('selected');
                document.getElementById('check-'+id).textContent = '‚úÖ';
            }
            document.getElementById('selCount').textContent = selectedIds.size;
        }

        function startSession() {
            if(selectedIds.size === 0) return;
            activeSession = {
                id: Date.now(),
                date: new Date().toISOString(),
                items: db.exercises.filter(e => selectedIds.has(e.id)).map(e => ({...e, done:false, linked:false}))
            };
            renderSession();
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-session').classList.remove('hidden');
        }

        function renderSession() {
            const list = document.getElementById('sessionList');
            list.innerHTML = activeSession.items.map((item, i) => {
                // Link Logic
                const prev = i > 0 && activeSession.items[i-1].linked;
                const curr = item.linked;
                let cls = '';
                if(curr && !prev) cls = 'is-linked-start';
                else if(curr && prev) cls = 'is-linked-mid';
                else if(!curr && prev) cls = 'is-linked-end';

                return `
                <div class="superset-wrap">
                    <div class="session-item ${item.done?'done':''} ${cls}">
                        <div class="check-circle" onclick="toggleDone(${i})">${item.done?'‚úì':''}</div>
                        <div style="flex:1">
                            <h3 style="margin:0;">${item.name}</h3>
                            <div style="font-size:12px; color:#888;">${item.notes}</div>
                            <div onclick="toggleLink(${i})" style="font-size:12px; font-weight:bold; color:${item.linked?'var(--primary)':'#555'}; margin-top:8px;">
                                ${item.linked ? 'üîó UNLINK' : 'üîó SUPERSET'}
                            </div>
                        </div>
                    </div>
                    <div class="link-bar"></div>
                </div>`;
            }).join('');
        }

        function toggleDone(i) {
            activeSession.items[i].done = !activeSession.items[i].done;
            renderSession();
        }
        function toggleLink(i) {
            if(i === activeSession.items.length-1) return;
            activeSession.items[i].linked = !activeSession.items[i].linked;
            renderSession();
        }

        function renderManage() {
            const list = document.getElementById('manageList');
            list.innerHTML = db.exercises.map(ex => `
                <div class="item-card">
                    <div>
                        <h3 style="margin:0;">${ex.name}</h3>
                        <div style="font-size:10px; margin-top:4px;">${ex.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
                    </div>
                    <button class="btn-reset" onclick="deleteExercise(${ex.id})" style="color:var(--danger);">Delete</button>
                </div>
            `).join('');
        }
        
        function openManage() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-manage').classList.remove('hidden');
        }
        
        function openAddModal() {
            document.getElementById('addName').value = '';
            document.getElementById('addNotes').value = '';
            document.querySelectorAll('#modal-add .tag').forEach(el => el.classList.remove('selected'));
            document.getElementById('modal-add').classList.add('open');
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JB Daily</title>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-alt: #2c2c2c;
            --primary: #BB86FC;
            --primary-var: #3700B3;
            --text: #e0e0e0;
            --text-muted: #a0a0a0;
            --danger: #cf6679;
            --success: #03dac6;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .btn-reset { background: none; border: none; color: inherit; font: inherit; cursor: pointer; padding: 0; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-row { display: flex; align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }

        /* HEADER */
        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-display { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        .settings-btn { font-size: 24px; opacity: 0.7; }

        /* SCREENS */
        .screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            transition: transform 0.2s ease;
        }

        /* --- HOME SCREEN --- */
        .weight-input-container {
            background: var(--surface);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .weight-input {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 32px;
            font-weight: 700;
            width: 100px;
            text-align: right;
        }
        .weight-input:focus { outline: none; }
        .unit { color: var(--text-muted); font-weight: 600; margin-left: 8px; }

        .day-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .day-btn {
            background: var(--surface-alt);
            padding: 24px 16px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            transition: transform 0.1s;
        }
        .day-btn:active { transform: scale(0.96); background: var(--primary-var); }
        .day-btn.cardio { grid-column: span 2; background: #232323; color: var(--success); }

        /* --- BUILDER SCREEN --- */
        .builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-bar {
            width: 100%;
            padding: 12px;
            background: var(--surface);
            border: none;
            border-radius: 8px;
            color: white;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .db-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 80px; }
        .db-item {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid transparent;
        }
        .db-item.selected {
            border-color: var(--primary);
            background: rgba(187, 134, 252, 0.1);
        }
        .db-info h3 { margin: 0 0 4px 0; font-size: 16px; }
        .db-meta { color: var(--text-muted); font-size: 13px; }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary);
            color: black;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        /* --- ACTIVE SESSION SCREEN --- */
        .session-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 100px; }
        
        .session-card-wrapper {
            position: relative;
            transition: all 0.3s ease;
        }
        
        /* SUPERSET STYLING */
        .session-card-wrapper.superset-start {
            margin-bottom: 0;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .session-card-wrapper.superset-start .session-card {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: 1px solid #333;
        }
        .session-card-wrapper.superset-middle {
            margin-top: 0;
            margin-bottom: 0;
            border-radius: 0;
        }
        .session-card-wrapper.superset-middle .session-card {
            border-radius: 0;
            border-bottom: 1px solid #333;
        }
        .session-card-wrapper.superset-end {
            margin-top: 0;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        .session-card-wrapper.superset-end .session-card {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        /* Visual Link Bar */
        .superset-link-bar {
            position: absolute;
            left: -12px;
            top: 10px;
            bottom: -14px;
            width: 4px;
            background: var(--primary);
            border-radius: 4px;
            display: none;
        }
        .superset-start .superset-link-bar { display: block; bottom: -14px; }
        .superset-middle .superset-link-bar { display: block; top: -14px; bottom: -14px; }
        .superset-end .superset-link-bar { display: block; top: -14px; bottom: 10px; }

        .session-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 16px;
        }

        .check-circle {
            width: 28px;
            height: 28px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .session-card.done .check-circle {
            background: var(--success);
            border-color: var(--success);
            color: black;
        }
        .session-card.done h3 { text-decoration: line-through; opacity: 0.5; }

        .card-content { flex: 1; }
        .card-content h3 { margin: 0 0 6px 0; font-size: 17px; }
        .badge {
            display: inline-block;
            background: #333;
            color: var(--text-muted);
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 700;
        }
        .notes-text {
            font-size: 14px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 6px;
            margin-top: 4px;
        }

        .action-row {
            display: flex;
            justify-content: flex-end;
            padding-top: 8px;
        }
        .icon-btn {
            font-size: 18px;
            padding: 8px;
            opacity: 0.5;
        }
        .icon-btn.active { opacity: 1; color: var(--primary); }

        /* SETTINGS MODAL */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 400px;
            padding: 24px; border-radius: 16px;
        }
    </style>
</head>
<body>

    <header>
        <div class="date-display" id="dateDisplay"></div>
        <button class="btn-reset settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
    </header>

    <div id="homeScreen" class="screen">
        <div class="weight-input-container">
            <span style="font-weight: 600; color: var(--text-muted);">BODY WEIGHT</span>
            <div class="flex-row">
                <input type="number" id="weightInput" class="weight-input" placeholder="---" onblur="saveWeight()">
                <span class="unit">lbs</span>
            </div>
        </div>

        <h3 style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px; letter-spacing: 1px;">SELECT WORKOUT</h3>
        <div class="day-grid">
            <button class="btn-reset day-btn" onclick="openBuilder('Push')">Push</button>
            <button class="btn-reset day-btn" onclick="openBuilder('Pull')">Pull</button>
            <button class="btn-reset day-btn" onclick="openBuilder('Legs')">Legs</button>
            <button class="btn-reset day-btn" onclick="openBuilder('Core')">Core</button>
            <button class="btn-reset day-btn cardio" onclick="openBuilder('Cardio')">Cardio</button>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn-reset" style="color: var(--text-muted); font-size: 14px; text-decoration: underline;" onclick="resumeSession()">Resume Active Session</button>
        </div>
    </div>

    <div id="builderScreen" class="screen hidden">
        <div class="builder-header">
            <button class="btn-reset" onclick="goHome()" style="font-size: 20px;">‚Üê Back</button>
            <h2 id="builderTitle" style="margin: 0; font-size: 20px;">Push</h2>
            <div style="width: 24px;"></div>
        </div>

        <input type="text" class="search-bar" placeholder="Filter exercises..." onkeyup="filterBuilder(this.value)">

        <div id="dbList" class="db-list">
            </div>

        <button class="btn-reset fab" onclick="startSession()">
            <span>GO</span>
            <span style="background:rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px;" id="selectedCount">0</span>
        </button>
    </div>

    <div id="sessionScreen" class="screen hidden">
        <div class="builder-header">
            <button class="btn-reset" onclick="goHome()" style="font-size: 16px; color: var(--text-muted);">Exit</button>
            <h2 style="margin: 0; font-size: 18px; color: var(--primary);">Active Workout</h2>
            <button class="btn-reset" onclick="finishSession()" style="font-size: 16px; color: var(--success);">Finish</button>
        </div>

        <div id="sessionList" class="session-list">
            </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Database</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Import your CSV to populate the exercise lists.</p>
            <input type="file" id="csvInput" accept=".csv" style="margin-bottom: 20px; width: 100%;">
            <div style="text-align: right;">
                <button class="btn-reset" style="padding: 10px 20px; background: var(--surface-alt); border-radius: 8px;" onclick="toggleSettings()">Close</button>
            </div>
            <div style="margin-top: 20px; font-size: 12px; color: #555;">
                <p>Database size: <span id="dbSize">0</span> exercises</p>
                <button class="btn-reset" style="color: var(--danger);" onclick="clearData()">Reset All Data</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let exercises = JSON.parse(localStorage.getItem('jb_exercises')) || [];
        let activeSession = JSON.parse(localStorage.getItem('jb_active_session')) || { items: [] };
        let weightLog = JSON.parse(localStorage.getItem('jb_weight')) || {};

        const DATES = {
            today: new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
            key: new Date().toISOString().split('T')[0]
        };

        // --- INIT ---
        document.getElementById('dateDisplay').textContent = DATES.today;
        if(weightLog[DATES.key]) document.getElementById('weightInput').value = weightLog[DATES.key];
        document.getElementById('dbSize').textContent = exercises.length;

        // --- NAVIGATION ---
        function goHome() {
            hideAll();
            document.getElementById('homeScreen').classList.remove('hidden');
        }

        function hideAll() {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
        }

        // --- WEIGHT ---
        function saveWeight() {
            const val = document.getElementById('weightInput').value;
            if(val) {
                weightLog[DATES.key] = val;
                localStorage.setItem('jb_weight', JSON.stringify(weightLog));
            }
        }

        // --- BUILDER LOGIC ---
        let currentBuilderDay = '';
        let selectedExercises = new Set();

        function openBuilder(day) {
            currentBuilderDay = day;
            selectedExercises.clear();
            updateFab();
            
            document.getElementById('builderTitle').textContent = `${day} Menu`;
            hideAll();
            document.getElementById('builderScreen').classList.remove('hidden');

            const list = document.getElementById('dbList');
            
            // Filter DB by Type (Muscle Group or Type column from CSV)
            // Assumes 'days' array exists on exercise object
            const dayExercises = exercises.filter(ex => 
                ex.days && ex.days.includes(day)
            );

            if(dayExercises.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555; margin-top:40px;">No ${day} exercises found.<br>Import CSV in settings.</div>`;
                return;
            }

            // Sort alphabetical
            dayExercises.sort((a,b) => a.name.localeCompare(b.name));

            list.innerHTML = dayExercises.map(ex => `
                <div class="db-item" id="db-item-${ex.id}" onclick="toggleSelection(${ex.id})">
                    <div class="db-info">
                        <h3>${ex.name}</h3>
                        <div class="db-meta">${ex.muscle || ''} ‚Ä¢ ${ex.notes ? 'Has notes' : ''}</div>
                    </div>
                    <div style="font-size:20px;">${selectedExercises.has(ex.id) ? '‚úÖ' : '‚¨ú'}</div>
                </div>
            `).join('');
        }

        function toggleSelection(id) {
            if(selectedExercises.has(id)) selectedExercises.delete(id);
            else selectedExercises.add(id);
            
            const el = document.getElementById(`db-item-${id}`);
            if(selectedExercises.has(id)) {
                el.classList.add('selected');
                el.querySelector('div:last-child').textContent = '‚úÖ';
            } else {
                el.classList.remove('selected');
                el.querySelector('div:last-child').textContent = '‚¨ú';
            }
            updateFab();
        }

        function updateFab() {
            document.getElementById('selectedCount').textContent = selectedExercises.size;
        }

        function filterBuilder(text) {
            const term = text.toLowerCase();
            document.querySelectorAll('.db-item').forEach(el => {
                const content = el.innerText.toLowerCase();
                el.style.display = content.includes(term) ? 'flex' : 'none';
            });
        }

        // --- SESSION LOGIC ---
        function startSession() {
            if(selectedExercises.size === 0) return;
            
            const selectedItems = exercises.filter(ex => selectedExercises.has(ex.id)).map(ex => ({
                ...ex,
                done: false,
                isSuperset: false // Links to the NEXT item
            }));

            activeSession = {
                startTime: Date.now(),
                items: selectedItems
            };
            saveSession();
            renderSession();
            hideAll();
            document.getElementById('sessionScreen').classList.remove('hidden');
        }

        function resumeSession() {
            if(activeSession.items.length > 0) {
                renderSession();
                hideAll();
                document.getElementById('sessionScreen').classList.remove('hidden');
            } else {
                alert("No active session.");
            }
        }

        function renderSession() {
            const list = document.getElementById('sessionList');
            
            list.innerHTML = activeSession.items.map((item, idx) => {
                // Superset visual logic
                let wrapperClass = '';
                const prev = activeSession.items[idx-1];
                const isLinked = item.isSuperset; // This item links to next
                const isLinkedFromPrev = prev && prev.isSuperset;

                if (isLinked && !isLinkedFromPrev) wrapperClass = 'superset-start';
                else if (isLinked && isLinkedFromPrev) wrapperClass = 'superset-middle';
                else if (!isLinked && isLinkedFromPrev) wrapperClass = 'superset-end';

                return `
                <div class="session-card-wrapper ${wrapperClass}">
                    <div class="superset-link-bar"></div>
                    <div class="session-card ${item.done ? 'done' : ''}">
                        <div class="check-circle" onclick="toggleDone(${idx})">
                            ${item.done ? '‚úì' : ''}
                        </div>
                        <div class="card-content">
                            <h3>${item.name}</h3>
                            <span class="badge">${item.muscle || 'General'}</span>
                            ${item.notes ? `<div class="notes-text">${item.notes}</div>` : ''}
                            
                            <div class="action-row">
                                <button class="btn-reset icon-btn ${item.isSuperset ? 'active' : ''}" 
                                        onclick="toggleSuperset(${idx})">
                                    üîó Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleDone(idx) {
            activeSession.items[idx].done = !activeSession.items[idx].done;
            saveSession();
            renderSession();
        }

        function toggleSuperset(idx) {
            // Cannot link the last item
            if(idx === activeSession.items.length - 1) return;
            
            activeSession.items[idx].isSuperset = !activeSession.items[idx].isSuperset;
            saveSession();
            renderSession();
        }

        function saveSession() {
            localStorage.setItem('jb_active_session', JSON.stringify(activeSession));
        }

        function finishSession() {
            if(confirm("Finish workout?")) {
                activeSession = { items: [] };
                saveSession();
                goHome();
            }
        }

        // --- IMPORT LOGIC ---
        function toggleSettings() {
            const el = document.getElementById('settingsModal');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                parseCSV(evt.target.result);
                document.getElementById('settingsModal').style.display = 'none';
            };
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/).filter(l => l.trim());
            const headers = lines[0].toLowerCase().split(',');
            
            // Expected: Exercise, Type, Muscle, Notes
            const map = {
                name: headers.findIndex(h => h.includes('exercise')),
                type: headers.findIndex(h => h.includes('type')),
                muscle: headers.findIndex(h => h.includes('muscle')),
                notes: headers.findIndex(h => h.includes('note'))
            };

            const newExs = [];
            for(let i=1; i<lines.length; i++) {
                // Regex to handle quoted CSV cells
                const row = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                if(!row) continue;
                const clean = row.map(s => s.replace(/^"|"$/g, '').trim());
                
                if(map.name === -1 || !clean[map.name]) continue;

                // Map Types to Days
                const typeStr = (clean[map.type] || '').toLowerCase();
                const days = [];
                if(typeStr.includes('push')) days.push('Push');
                if(typeStr.includes('pull')) days.push('Pull');
                if(typeStr.includes('legs')) days.push('Legs');
                if(typeStr.includes('core')) days.push('Core');
                if(typeStr.includes('cardio') || typeStr.includes('run')) days.push('Cardio');

                newExs.push({
                    id: Date.now() + i,
                    name: clean[map.name],
                    days: days,
                    muscle: clean[map.muscle] || '',
                    notes: clean[map.notes] || ''
                });
            }

            exercises = newExs;
            localStorage.setItem('jb_exercises', JSON.stringify(exercises));
            document.getElementById('dbSize').textContent = exercises.length;
            alert(`Imported ${exercises.length} exercises.`);
        }

        function clearData() {
            if(confirm("Clear all data?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
